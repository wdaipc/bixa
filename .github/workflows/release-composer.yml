
name: ğŸ“¦ æ„å»ºå¹¶å‘å¸ƒï¼ˆComposer / å®˜æ–¹åŒ…ï¼‰

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ï¼š2.0.2ï¼‰'
        required: true
      use_official:
        description: 'æ˜¯å¦ä½¿ç”¨å®˜æ–¹å‘å¸ƒåŒ…ï¼ˆæ¥è‡ª bixacloud ä»“åº“ï¼‰ï¼Ÿ'
        type: boolean
        required: false
        default: false

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§° å‡†å¤‡æ„å»ºç›®å½•
        run: mkdir workspace

      - name: ğŸŒ ä¸‹è½½å¹¶è§£å‹å®˜æ–¹åŒ…ï¼ˆå¦‚æœé€‰æ‹©ï¼‰
        if: ${{ github.event.inputs.use_official == 'true' }}
        run: |
          echo "âœ… ä½¿ç”¨å®˜æ–¹åŒ…ç‰ˆæœ¬ v${{ github.event.inputs.version }}"
          curl -L "https://github.com/bixacloud/bixa/archive/refs/tags/v${{ github.event.inputs.version }}.zip" -o source.zip
          unzip source.zip -d workspace
          mv workspace/*/* workspace/

      - name: ğŸ“¥ æ‹‰å–å½“å‰ä»“åº“ä»£ç ï¼ˆé»˜è®¤ï¼‰
        if: ${{ github.event.inputs.use_official != 'true' }}
        uses: actions/checkout@v4
        with:
          path: workspace

      - name: âš™ï¸ å®‰è£… PHP ä¸ Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, zip, intl
          tools: composer

      - name: ğŸ“¦ å®‰è£…ç”Ÿäº§ç¯å¢ƒä¾èµ–ï¼ˆComposerï¼‰
        working-directory: workspace
        run: composer install --no-dev --optimize-autoloader

      - name: ğŸ§¹ æ¸…ç†å¹¶å‡†å¤‡å‘å¸ƒç›®å½•
        run: |
          mkdir release
          rsync -av --exclude='.git*' --exclude='tests' --exclude='.github' \
                    --exclude='composer.*' --exclude='*.lock' \
                    --exclude='vendor/bin' workspace/ release/

      - name: ğŸ—œï¸ ç”Ÿæˆå‹ç¼©åŒ…
        run: |
          cd release
          zip -r ../bixa-v${{ github.event.inputs.version }}-composer.zip ./

      - name: ğŸš€ å‘å¸ƒ Release åˆ° GitHub
        uses: softprops/action-gh-release@v2
        with:
          name: ğŸ“¦ bixa v${{ github.event.inputs.version }}ï¼ˆcomposer æ„å»ºï¼‰
          tag_name: v${{ github.event.inputs.version }}-composer
          files: bixa-v${{ github.event.inputs.version }}-composer.zip
          body: |
            ğŸ‰ å‘å¸ƒç‰ˆæœ¬ï¼šv${{ github.event.inputs.version }}
            ğŸ”§ æ„å»ºæ–¹å¼ï¼š${{ github.event.inputs.use_official == 'true' && 'å®˜æ–¹æºç åŒ…' || 'å½“å‰ä»“åº“æºç ' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
